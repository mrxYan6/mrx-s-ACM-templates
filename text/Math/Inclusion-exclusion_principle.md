# 容斥原理

容斥原理，类似于集合的交集与并集的关系，但是更加灵活，可以处理更多的情况。

## trick

### 通过多项式快速计算容斥系数

在进行容斥的时候可能发现集合大小非常大，这个时候又发现了容斥的式子是只跟集合中元素大小和有关的，那么就可能可以使用多项式快速计算容斥系数。

**[Cargo](https://acm.hdu.edu.cn/showproblem.php?pid=7381)**

题意简述:

有 n 家店铺出售 m 种物品。每家店铺只售卖一种物品，第 i 家店铺出售第 $a_i$ 种物品。

你打算购买一些物品。你将进行以下操作 k 次：随机选择一家店铺，从该店铺购买一个物品。

假设有 $c_i$ 家店铺出售第 i 种物品。在所有操作完成后，你会感到不满意，当且仅当满足以下条件：

存在一种物品 i，你恰好拥有 $c_i$ 个该物品，并且它们都来自不同的店铺。

求满意的概率。

解法:

这个题很容易想到进行容斥，很容易得到其答案为 1 - 不满意的并集，求这个并集很容易想到使用容斥原理。

然后发现式子只跟选定的不满意的种类的大小和有关，然后这时候可以使用多项式 $\prod\limits_{i = 1}^{i = n}1-x^{c_i}$ 这个时候多项式的指数位表示了大小，系数表示了所有容斥式子中对应大小的系数和。这样就可以 $O(nlog^2(n))$ 求出答案了。(ps:题解使用了EGF，复杂度为$O(nlog(n))$，但是实际上我的分治fft跑的更快，而且更好理解，虽然我这个多项式也可以使用trick 付公主的背包优化，复杂度也是$O(nlog(n))$，但是慢了一倍，我也不理解)。



### 暴力容斥

二进制枚举集合，根据集合对应的popcount的奇偶性来决定加还是减。

**[LCM Plus GCD](https://codeforces.com/gym/104396/problem/E)**

题意:有多少个本质不同的大小为$k$ 的集合，使得集合中所有元素的gcd+lcm=x。

trick:暴力容斥。

注意到 $x = (gcd(a_1,a_2,a_3,...,a_k) + lcm(a_1,a_2,a_3,...,a_k)) = gcd(a_1,a_2,a_3,...,a_k) * (1 + A)$。
那么考虑枚举 $d = gcd(a_1a_2,a_3,...,a_k)$

记 $(a_i',a_2',...a_k')=(a_1/d,a_2/d,...a_k/t)$ 

可知 $gcd(a_1',a_2',a_3',...,a_k')=1$，而且因为有 $ A = lcm / gcd $ ,所以 $(a_1',...a_k')$ 中的所有元素都是 $A$ 的因子。

那么对于 $A$ 枚举质因数。集合中的第 $i$ 个元素 $a_i'$ 对于 $A$ 的第 $j$ 个因子有:$ min_i(c_{i,j}) = 0, max_i(c_{i,j}) = e_j $ 其中 $e_j$ 为 $A$ 的第 $j$ 个因子的指数。

如果没有限制那么对于 $A$ 的第 $j$ 个因子，有 $e_j+1$ 种选择，所以一共有 $\prod_{i=1}^{m}(e_i+1)$ 种选择。

如果某个j限制了上界/下界，那么就是 $e_j$ 种选择。

如果上下界都限制了，那么就是 $e_j - 1$ 种选择。

在这些选择中选 $k$ 个即为集合的方案数。

然后暴力二进制枚举某个 $j$ 的上下界是否被限制，然后根据选择和限制的奇偶性来决定加还是减。

截取具体实现的一部分:
```cpp
int m = p.size();
Z ret = 0;
for (int s = 0; s < 1 << m; ++s) {
    for (int t = 0; t < 1 << m; ++t) {
        int cur = 1;
        int coef = 1;
        for (int i = 0; i < m; ++i) {
            int now = cnt[i] + 1;
            if (s >> i & 1) {
                now--;
                coef *= -1;
            }
            if (t >> i & 1) {
                now--;
                coef *= -1;
            }
            cur *= now;
        } 
        ret += coef * comb.binom(cur, k);
    }
}
```